name: Build Windows Single File RustDesk

on:
  workflow_dispatch:
  push:
    branches: [ master, main ]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      # --- vcpkg manifest 模式（RustDesk 必须用这种） ---
      - name: Install vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          .\vcpkg\bootstrap-vcpkg.bat

      - name: Install dependencies (manifest)
        run: |
          .\vcpkg\vcpkg install --triplet x64-windows-static

      # -------------------------
      #    Build RustDesk
      # -------------------------
      - name: Build RustDesk portable
        run: |
          python build.py --portable --flutter
        shell: powershell

      # -------------------------
      #    生成单文件 SFX
      # -------------------------
      - name: Install 7zip
        run: choco install 7zip -y

      - name: Build SFX Config
        run: |
          echo ;!@Install@!UTF-8! > config.txt
          echo RunProgram="rustdesk.exe" >> config.txt
          echo GUIMode="2" >> config.txt
          echo ;!@InstallEnd@! >> config.txt

      - name: Pack to Single EXE
        run: |
          cd flutter\build\windows\x64\runner\Release
          7z a app.7z * -mx9
          copy /b "C:\Program Files\7-Zip\7z.sfx" + ..\..\..\..\..\config.txt + app.7z rustdesk_single.exe

      - name: Upload Single File EXE
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows-single-file
          path: flutter/build/windows/x64/runner/Release/rustdesk_single.exe
